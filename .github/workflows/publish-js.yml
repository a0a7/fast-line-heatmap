name: Publish JavaScript Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        default: 'patch'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: dist/javascript/package-lock.json
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
    
    - name: Install wasm-pack
      run: cargo install wasm-pack
    
    - name: Build WebAssembly
      run: |
        cd core
        wasm-pack build --target web --out-dir ../dist/javascript/wasm --allow-dirty
    
    - name: Install dependencies
      run: |
        cd dist/javascript
        npm ci
    
    - name: Build package
      run: |
        cd dist/javascript
        npm run build
    
    - name: Run tests
      run: |
        cd dist/javascript
        npm test
    
    # Publish to npm registry
    - name: Setup npm authentication
      run: |
        cd dist/javascript
        echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
    
    - name: Publish to npm
      run: |
        cd dist/javascript
        npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    # Publish to GitHub Packages
    - name: Setup GitHub Packages authentication
      run: |
        cd dist/javascript
        echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > .npmrc
        echo "@a0a7:registry=https://npm.pkg.github.com" >> .npmrc
    
    - name: Modify package.json for GitHub Packages
      run: |
        cd dist/javascript
        # Backup original
        cp package.json package.json.npm
        # Update for GitHub Packages
        jq '.name = "@a0a7/fastgeotoolkit" | .publishConfig = {"registry": "https://npm.pkg.github.com", "access": "public"}' package.json > package.json.github
        mv package.json.github package.json
    
    - name: Publish to GitHub Packages
      run: |
        cd dist/javascript
        npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Restore original package.json
      run: |
        cd dist/javascript
        mv package.json.npm package.json
    
    - name: Create release summary
      run: |
        echo "## ðŸ“¦ Package Published Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Published to:" >> $GITHUB_STEP_SUMMARY
        echo "- **npm**: [fastgeotoolkit](https://www.npmjs.com/package/fastgeotoolkit)" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Packages**: [@a0a7/fastgeotoolkit](https://github.com/a0a7/fastgeotoolkit/packages)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# From npm" >> $GITHUB_STEP_SUMMARY
        echo "npm install fastgeotoolkit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# From GitHub Packages" >> $GITHUB_STEP_SUMMARY
        echo "npm install @a0a7/fastgeotoolkit" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
